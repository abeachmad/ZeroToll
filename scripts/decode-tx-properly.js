const hre = require("hardhat");

async function main() {
  const { ethers } = hre;
const ABI = ["function executeIntent((address user, address tokenIn, uint256 amtIn, address tokenOut, uint256 minOut, uint256 dstChainId, uint256 deadline, address feeToken, uint256 feeMode, uint256 feeCapToken, bytes adapterCallData, uint256 extraData) route, address adapter, uint256 feeMode)"];

const iface = new ethers.Interface(ABI);

//  TX GAGAL: 0x22bc8dff
const failedTx = "0xe60269c600000000000000000000000000000000000000000000000000000000000000600000000000000000000000007cafe27c7367fa0e929d4e83578cec838e3ceec700000000000000000000000000000000000000000000000000000000000002000000000000000000000000005a87a3c738cf99db95787d51b627217b6de12f6200000000000000000000000041e94eb019c0762f9bfcf9fb1e58725bfb0e758200000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000360ad4f9a9a8efe9a8dcb5f461c4cc1047e1dcf9000000000000000000000000000000000000000000000000004d1c6bba68300000000000000000000000000000000000000000000000000000000000001388200000000000000000000000000000000000000000000000000000000690f7deb00000000000000000000000041e94eb019c0762f9bfcf9fb1e58725bfb0e75820000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000002386f26fc10000000000000000000000000000000000000000000000000000000000000000018000000000000000000000000000000000000000000000000000000000690f7b93000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c49908fc8b00000000000000000000000041e94eb019c0762f9bfcf9fb1e58725bfb0e7582000000000000000000000000360ad4f9a9a8efe9a8dcb5f461c4cc1047e1dcf900000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000004d1c6bba683000000000000000000000000005335f887e69f4b920bb037062382b9c17aa52ec600000000000000000000000000000000000000000000000000000000690f7deb00000000000000000000000000000000000000000000000000000000";

// TX BERHASIL: 0x65c40c20
const successTx = "0xe60269c600000000000000000000000000000000000000000000000000000000000000600000000000000000000000007cafe27c7367fa0e929d4e83578cec838e3ceec700000000000000000000000000000000000000000000000000000000000002000000000000000000000000005a87a3c738cf99db95787d51b627217b6de12f62000000000000000000000000360ad4f9a9a8efe9a8dcb5f461c4cc1047e1dcf90000000000000000000000000000000000000000000000000de0b6b3a764000000000000000000000000000041e94eb019c0762f9bfcf9fb1e58725bfb0e7582000000000000000000000000000000000000000000000000000000000008554a000000000000000000000000000000000000000000000000000000000001388200000000000000000000000000000000000000000000000000000000690f7e6b000000000000000000000000360ad4f9a9a8efe9a8dcb5f461c4cc1047e1dcf90000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000002386f26fc10000000000000000000000000000000000000000000000000000000000000000018000000000000000000000000000000000000000000000000000000000690f7c13000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c49908fc8b000000000000000000000000360ad4f9a9a8efe9a8dcb5f461c4cc1047e1dcf900000000000000000000000041e94eb019c0762f9bfcf9fb1e58725bfb0e75820000000000000000000000000000000000000000000000000de0b6b3a7640000000000000000000000000000000000000000000000000000000000000008554a0000000000000000000000005335f887e69f4b920bb037062382b9c17aa52ec600000000000000000000000000000000000000000000000000000000690f7e6b00000000000000000000000000000000000000000000000000000000";

console.log("=== DECODING TRANSACTION DATA ===\n");

try {
  console.log("FAILED TX (USDC → WMATIC):");
  const failed = iface.decodeFunctionData("executeIntent", failedTx);
  const failedRoute = failed.route;
  console.log(`  User: ${failedRoute.user}`);
  console.log(`  TokenIn: ${failedRoute.tokenIn}`);
  console.log(`  AmtIn: ${ethers.formatUnits(failedRoute.amtIn, 6)} USDC`);
  console.log(`  TokenOut: ${failedRoute.tokenOut}`);
  console.log(`  MinOut: ${ethers.formatUnits(failedRoute.minOut, 18)} WMATIC`);
  console.log(`  MinOut (raw): ${failedRoute.minOut.toString()}`);
  console.log("");
  
  console.log("SUCCESS TX (WMATIC → USDC):");
  const success = iface.decodeFunctionData("executeIntent", successTx);
  const successRoute = success.route;
  console.log(`  User: ${successRoute.user}`);
  console.log(`  TokenIn: ${successRoute.tokenIn}`);
  console.log(`  AmtIn: ${ethers.formatEther(successRoute.amtIn)} WMATIC`);
  console.log(`  TokenOut: ${successRoute.tokenOut}`);
  console.log(`  MinOut: ${ethers.formatUnits(successRoute.minOut, 6)} USDC`);
  console.log(`  MinOut (raw): ${successRoute.minOut.toString()}`);
  console.log("");
  
  console.log("=== ANALYSIS ===");
  const failedMinOut = parseFloat(ethers.formatUnits(failedRoute.minOut, 18));
  const failedAmtIn = parseFloat(ethers.formatUnits(failedRoute.amtIn, 6));
  console.log(`FAILED: Asking for ${failedMinOut.toFixed(4)} WMATIC from ${failedAmtIn} USDC`);
  console.log(`Expected: ~5.55 WMATIC (oracle rate: 1 USDC = ~5.55 WPOL)`);
  console.log(`Ratio: ${(failedMinOut / failedAmtIn).toFixed(4)} WMATIC per USDC`);
  if (failedMinOut > 5.55) {
    console.log("❌ BUG: minOut TOO HIGH! Adapter cannot provide this much!");
  } else {
    console.log("✅ minOut looks reasonable");
  }
  
} catch (error) {
  console.error("Decode error:", error.message);
}
}

main()
  .then(() => process.exit(0))
  .catch((error) => {
    console.error(error);
    process.exit(1);
  });
